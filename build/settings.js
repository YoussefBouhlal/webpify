(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var s in a)e.o(a,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:a[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.domReady;var a=e.n(t);const s=window.wp.element,i=window.wp.apiFetch;var n=e.n(i);const o=window.wp.data,r=window.wp.notices,l=window.wp.i18n,p=window.wp.components,c=window.ReactJSXRuntime,d=()=>{const{removeNotice:e}=(0,o.useDispatch)(r.store),t=(0,o.useSelect)(e=>e(r.store).getNotices());return 0===t.length?null:(0,c.jsx)(p.NoticeList,{notices:t,onRemove:e})},_=({format:e,setFormat:t,isPhpCompatibleAvif:a})=>(0,c.jsx)(p.PanelBody,{title:(0,l.__)("General settings","webpify"),children:(0,c.jsx)("div",{className:"webpify-settings__field-container",children:(0,c.jsx)(p.SelectControl,{__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0,label:(0,l.__)("Format","webpify"),value:e,onChange:t,children:(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("option",{value:"1",children:(0,l.__)("WebP","webpify")}),(0,c.jsxs)("option",{disabled:!a,value:"2",children:[(0,l.__)("AVIF","webpify")," ",!a&&(0,l.__)("(PHP 8.1 or higher)","webpify")]})]})})})}),w=({display:e,setDisplay:t,startBulkOptimization:a,stopBulkOptimization:s,startBulk:i,progressText:n})=>(0,c.jsxs)(p.PanelBody,{title:(0,l.__)("Bulk settings","webpify"),children:[(0,c.jsx)("div",{className:"webpify-settings__field-container",children:(0,c.jsx)(p.RadioControl,{label:(0,l.__)("Display images with new format on the site","webpify"),selected:e,options:[{label:(0,l.__)("Deactivate","webpify"),value:"1"},{label:(0,l.__)("Use rewrite rules","webpify"),value:"2"}],onChange:t})}),(0,c.jsx)(p.PanelRow,{children:(0,c.jsxs)("div",{className:"webpify-settings__field-container",children:[(0,c.jsx)("div",{className:"webpify-settings__button__label",children:(0,l.__)("Bulk optimization","webpify")}),i?(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(p.Button,{isDestructive:!0,variant:"secondary",onClick:s,__next40pxDefaultSize:!0,children:(0,l.__)("Stop","webpify")}),(0,c.jsx)("div",{className:"webpify-settings__progress",children:(0,c.jsx)(p.ProgressBar,{})})]}):(0,c.jsx)(p.Button,{variant:"secondary",onClick:a,__next40pxDefaultSize:!0,children:(0,l.__)("Start","webpify")}),(0,c.jsx)("div",{className:"webpify-settings__description",children:n})]})})]}),h=({saveSettings:e})=>(0,c.jsx)(p.PanelBody,{children:(0,c.jsx)(p.Button,{variant:"primary",onClick:e,__next40pxDefaultSize:!0,children:(0,l.__)("Save","webpify")})}),{optionName:f,ajaxUrl:u,nonce:y,isPhpCompatibleAvif:m}=WEBPIFY_SETTINGS,b=()=>{const[e,t]=(0,s.useState)(),[a,i]=(0,s.useState)(),[b,g]=(0,s.useState)(!1),[x,v]=(0,s.useState)(""),{createSuccessNotice:j,createErrorNotice:S,removeNotice:P}=(0,o.useDispatch)(r.store);return(0,s.useEffect)(()=>{n()({path:"/wp/v2/settings"}).then(e=>{const a=e.webpify_settings;t(a.format),i(a.display)})},[]),(0,s.useEffect)(()=>{const e=setInterval(()=>{if(!b)return;const t=new FormData;t.append("action","webpify_bulk_optimization_progress"),t.append("_wpnonce",y),fetch(u,{method:"POST",body:t}).then(e=>e.json()).then(t=>{t.success&&(v(t.data.progress),t.data.running||(clearInterval(e),g(!1)))}).catch(()=>{clearInterval(e),g(!1),v((0,l.__)("Unxpected error. Please reload the page and try again.","webpify"))})},5e3);return()=>clearInterval(e)},[b]),(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(d,{}),(0,c.jsxs)(p.Panel,{children:[(0,c.jsx)(_,{format:e,setFormat:t,isPhpCompatibleAvif:m}),(0,c.jsx)(w,{display:a,setDisplay:i,stopBulkOptimization:()=>{g(!1),v("");const e=new FormData;e.append("action","webpify_bulk_optimization_end"),e.append("_wpnonce",y),fetch(u,{method:"POST",body:e}).then(e=>e.json()).then(e=>{e.success||v(e.data)}).catch(()=>{v((0,l.__)("Unxpected error. Please reload the page and try again.","webpify"))})},startBulkOptimization:()=>{g(!0),v("");const e=new FormData;e.append("action","webpify_bulk_optimization_start"),e.append("_wpnonce",y),fetch(u,{method:"POST",body:e}).then(e=>e.json()).then(e=>{e.success?v(e.data.progress):(v(e.data),g(!1))}).catch(()=>{g(!1),v((0,l.__)("Unxpected error. Please reload the page and try again.","webpify"))})},startBulk:b,progressText:x}),(0,c.jsx)(h,{saveSettings:()=>{wp.data.select(r.store).getNotices().forEach(e=>P(e.id)),n()({path:"/wp/v2/settings",method:"POST",data:{[f]:{format:e,display:a}}}).then(()=>{j((0,l.__)("Settings saved","webpify"))}).catch(e=>{S(e.message)})}})]})]})};a()(()=>{(0,s.createRoot)(document.getElementById("JS-webpify-settings")).render((0,c.jsx)(b,{}))})})();